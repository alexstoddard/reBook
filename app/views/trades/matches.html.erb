<div id="main">
	<div id="matches">
		<h1>Your Trade Matches</h1>
		<% @inventory_needs.each do |x| %>
			<% if @need_hash[x.id][:completed].size == 0 #do not show complete trades (trades already accepted by all users)%>
				<% 
				@pending_count = @need_hash[x.id][:accepted].size #number of users who have accepted this trade 
				@proposed_count = @need_hash[x.id][:active].size #number of trades proposed by another user to this current user
				@possible_count = @need_hash[x.id][:possible].size #number of possible trades
				if @proposed_count > 0 #at least one proposed trade-> green header %>
					<article class="green">
				<% elsif @pending_count > 0 #pending trade-> grey header %>
					<article class="grey">
				<% elsif @possible_count == 0 #no possible trades-> red header %>
					<article class="red">
				<% else #normal->blue header %>
					<article>
				<% end %>
					<h3><span>Get this book:</span><br />
				    	<%= x.book.name %></h3>
				    
				    <div class="need-details">	
				    	<%= image_tag(x.book.thumbnail, alt: x.book.name, class: "bookcover") %>
						<p><strong>Author:</strong> <%= x.book.author %><br />
						<strong>ISBN:</strong> <%= x.book.isbn %><br />
						<strong>Published:</strong> <%= x.book.published %></p>
				    </div>

				    <div class="trade-info">
			    		<div class="pending-trades">
			    			<% if @pending_count > 0 %>
				    			<p>This trade is pending.</p>
				    			<% #don't show trade line corresponding to current user (they were the one who proposed the trade)
				    			other_trades = @need_hash[x.id][:accepted].first.get_tradelines_except(session[:user_id])
				    			other_trades.each do |y| 
				    				if y.user_from_accepted %>
				    					<p><%= y.inventory_own.user.username %> has accepted this trade.</p>
				    				<% else %>
				    					<p><%= y.inventory_own.user.username %> has not yet accepted this trade.</p>
				    				<% end
				    			end %>
								<%= link_to "View Trade", "/trade_details/" + @need_hash[x.id][:accepted][0].id.to_s %>
				    			<p><a href="#">Cancel this trade.</a></p>
				    		<% end %>
			    		</div>
			    		<div class="proposed-trades">
					    	<% if @proposed_count > 0 #show message for proposed trades %>
					    		<% if @proposed_count == 1 %>
					  				<p>1 user has proposed a trade to you. <%= link_to "View Trade »", "/match_details/" + x.id.to_s %></p>
					  			<% else %>
					  				<p><% @proposed_count %> users have proposed trades to you. <%= link_to "View Trades »", "/match_details/" + x.id.to_s %></p>
					  			<% end %>
					  			
					    	<% end %>
						</div>
						<div class="possible-trades">
							<% if @pending_count == 0 and @possible_count > 0 #show trade options that user can propose %>
								<% if @possible_count == 1 %>
						    		<p>There is 1 possible trade for this book.</p>
						    	<% else %>
						    		<p>There are <%= @possible_count %> possible trades for this book.</p>
						    	<% end %>

						    	<ul class="trades">
							    	<% # list first three possible trade
							    	@need_hash[x.id][:possible].take(3).each do |trade| %>
							    		<li>
							    		 	<% 
							    		 	@my_tradeline = trade.get_tradeline_only(session[:user_id])
							    		 	@from_tradeline  = trade.get_tradeline_from(session[:user_id]) %>
							    		 	
											<%= image_tag @my_tradeline.inventory_own.book.thumbnail, alt: @my_tradeline.inventory_own.book.name %><br />
										    <p>

										    <strong>Trade your book:</strong> <%= @my_tradeline.inventory_own.book.name %><br />
										    <strong>Trade with:</strong> <%= @from_tradeline.inventory_own.user.username %><br />
										    Their book is in <%= @from_tradeline.inventory_own.condition.description.downcase %> condition.
										    

										    <% if trade.trade_lines.size > 2 %>
										    	<br /><strong>This is a <%= trade.trade_lines.size %>-way trade.</strong>
										    <% end %>
										    </p>
									    </li>
							    	<% end %>
						    	</ul>
						    	<% if @possible_count > 3 %>
						    		<p class="view-more"><%= link_to "View More Matches »", "/match_details/" + x.id.to_s %></p>
						    	<% else %>
						    		<p class="view-more"><%= link_to "Propose a Trade »", "/match_details/" + x.id.to_s %></p>
						    	<% end %>
						    <% elsif @pending_count == 0 and @possible_count == 0 and @proposed_count == 0#no possible trades  %>
						    	<p class="no-matches">Sorry, there are no Trade Matches for this book at the moment. Try adding more books to your Have List or checking back later.</p>
						    <% end %>
					    </div>
					</div>
				</article>
			<% end #if %>
		<% end #each %> 
	</div>
</div>
