<script type="text/javascript">
  jQuery(document).ready(function($) {
  	$('a[rel*=facebox]').facebox() 

  	$('#show-incomplete-trades').click(function(e) {
  		e.preventDefault();
  		$(this).hide();
  		$('.incomplete-trades .trades').show();
  	});

  	$('#hide-incomplete-trades').click(function(e) {
  		e.preventDefault();
  		$('.incomplete-trades .trades').hide();
  		$('#show-incomplete-trades').show();
  	})

  });
</script>
<div id="main">
	<div id="my-trades">
		<h1>Your Trades</h1>

		<div class="active-trades">
			<h2>Active Trades</h2>
			<% if @trade_hash[:completed].size == 0 %>
				<p>You have no active trades right now.</p>
			<% else %>
				<% @trade_hash[:completed].each do |y| %>
        			<% x = y.user_need(@user.id).inventory_need %>
					<article>
					
						<h3><span>Get this book:</span> <%= x.book.name %></h3>
					    
					    <%= image_tag(x.book.thumbnail, alt: x.book.name, class: "bookcover") %>
					    
					    <div class="need-details">	
							<p><strong>Author:</strong> <%= x.book.author %><br />
							<strong>ISBN:</strong> <%= x.book.isbn %><br />
							<strong>Published:</strong> <%= x.book.published %></p>
					    </div>

					    <div class="trade-info">
					    	<% #find latest trade note with time and locationn
			    			y.trade_notes.reverse.each do |note| 
			    				if (!note.meet_time.nil? && !note.place.nil? && !note.meet_time.empty? && !note.place.empty?) %>
			    					<p>
				    					Meet Time/Date: <%= note.meet_time %><br />
				    					Meet Location: <%= note.place %> 
				    						<% if y.location %>
				    							(<%= y.location.name %>)
				    						<% end %>
				    				</p>

				    				<% #check to see if current time/date is past the trade time/date %> 
				    				<% @now = Time.strptime("5:30am 12/05/2013", "%l:%M%P %m/%d/%Y") 
				    				#@now = Time.now.in_time_zone(@user.timezone)
				    				#@now = @now - 15*60 #(15 minutes from now)
				    				@trade_time = Time.strptime(note.meet_time, "%l:%M%P %m/%d/%Y") 
				    				if @now > @trade_time %>
				    					<% @complete = true %>
				    				<% end %>

			    					<% break %>
			    				<% end %>
			    			<% end %>

			    			<% if @complete # trade is complete %>
			    				<p>Trade has been completed. Please provide feedback. 
			    			<% else # active trade, not yet complete %>
				    			<p>This trade is currently active.</p>

				    			<p class="action"><%= link_to "View Trade Details", "/trade_details/" + y.id.to_s %></p>

				    			<p class="action">
				    				<%= render partial: 'change_trade_button', locals: { trade: y } %>
				    				<%= render partial: 'cancel_trade_button', locals: { trade: y } %>
				    			</p>
				    		<% end %>

						</div>
					</article>
				<% end #each, trade_hash loop %>
			<% end#if %>
		</div>

		<% if @trade_hash[:accepted].size != 0 %>
			<div class="pending-trades">
				<h2>Pending Trades</h2>
				
				<% @trade_hash[:accepted].each do |y| %>
					<% x = y.user_need(@user.id).inventory_need %>
					<article>
						<h3><span>Trying to Get this book:</span> <%= x.book.name %></h3>
					    
					    <%= image_tag(x.book.thumbnail, alt: x.book.name, class: "bookcover") %>
					    
					    <div class="need-details">	
							<p><strong>Author:</strong> <%= x.book.author %><br />
							<strong>ISBN:</strong> <%= x.book.isbn %><br />
							<strong>Published:</strong> <%= x.book.published %></p>
					    </div>

					    <div class="trade-info">
			    			<p>This trade is pending.</p>
			    			<p>You have accepted this trade.</p>
			    			<% other_tradelines = y.get_tradelines_except(session[:user_id])
			    			other_tradelines.each do |tradeline| 
			    				if tradeline.user_from_accepted %>
			    					<p><%= render :partial => 'users/user', locals: { display_user: tradeline.inventory_own.user } %> has accepted this trade.</p>
			    				<% else %>
			    					<p><%= render :partial => 'users/user', locals: { display_user: tradeline.inventory_own.user } %> has not yet accepted this trade.</p>
			    				<% end %>
			    			<% end %>

			    			<p class="action"><%= link_to "View Trade Details", "/trade_details/" + y.id.to_s %></p>

			    			<p class="action">
			    				<%= render partial: 'change_trade_button', locals: { trade: y } %>
			    				<%= render partial: 'cancel_trade_button', locals: { trade: y } %>
			    			</p>
						</div>
					</article>
				<% end#each %>
			</div>
		<% end %>

		<% if @trade_hash[:declined].size != 0 %>
			<div class="incomplete-trades">
				<h3><a href="#" id="show-incomplete-trades">View Incomplete Trades</a></h3>

				<div class="trades">
					<h2>Incomplete Trades <span>(<a href="#" id="hide-incomplete-trades">hide</a>)</span></h2>
					<% @trade_hash[:declined].each do |y| %>
		    			<% x = y.user_need(@user.id).inventory_need %>
								
						<article>
							<h3><span>Did not get this book:</span> <%= x.book.name %></h3>
						    
						    <%= image_tag(x.book.thumbnail, alt: x.book.name, class: "bookcover") %>

						    <div class="need-details">	
								<p><strong>Author:</strong> <%= x.book.author %><br />
								<strong>ISBN:</strong> <%= x.book.isbn %><br />
								<strong>Published:</strong> <%= x.book.published %></p>
						    </div>

						    <div class="trade-info">
				    			<p>This trade was canceled before it was completed.</p>
				    			<% #list other users involved in the trade
				    			other_trades = y.get_tradelines_except(session[:user_id])
				    			other_trades.each do |z| 
				    				if z.user_from_accepted %>
				    					<p><%= render :partial => 'users/user', locals: { display_user: z.inventory_own.user } %> has accepted this trade.</p>
				    				<% else %>
				    					<p><%= render :partial => 'users/user', locals: { display_user: z.inventory_own.user } %> was part of this trade.</p>
				    				<% end
				    			end %>

								<p class="action"><%= link_to "View Trade Details", "/trade_details/" + y.id.to_s %></p>
								<p class="action">
									<%= render :partial => 'repropose_trade_button', locals: { trade: y } %>
								</p>
							</div>
						</article>
		 			<% end #each, inventory_needs loop %>
		 		</div>
	 		</div>
	 	<% end %>

	</div>
</div>
