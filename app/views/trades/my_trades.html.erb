<script type="text/javascript">
  jQuery(document).ready(function($) {
  $('a[rel*=facebox]').facebox() 
  })
</script>
<div id="main">
	<div id="my-trades">
		<h1>Your Trades</h1>

		<div class="active-trades">
			<h2>Active Trades</h2>
			<% if @inventory_needs.all? { |x| @need_hash[x.id][:completed].size == 0} %>
				<p>You have no active trades.</p>
			<% else %>

				<% @inventory_needs.each do |x| %>
					<% if @need_hash[x.id][:completed].size > 0 #trades that have been accepted by all users %>	


						<% @need_hash[x.id][:completed].each do |y| %>
				  		
							<article>
							
								<h3><span>Get this book:</span> <%= x.book.name %></h3>
							    
							    <%= image_tag(x.book.thumbnail, alt: x.book.name, class: "bookcover") %>
							    
							    <div class="need-details">	
									<p><strong>Author:</strong> <%= x.book.author %><br />
									<strong>ISBN:</strong> <%= x.book.isbn %><br />
									<strong>Published:</strong> <%= x.book.published %></p>
							    </div>

							    <div class="trade-info">
					    			<p>This trade is currently active.</p>



					    			<p class="action"><%= link_to "View Trade Details", "/trade_details/" + y.id.to_s %></p>

					    			<p class="action"><%= link_to "Change Trade", "/update_trade/" + y.id.to_s + '?type=change', :action => :get, :rel => "facebox", :class => "counter-trade" %>
					    			<%= link_to "Cancel Trade", "/decline_trade/" + y.id.to_s, :rel => "facebox", :class => "cancel-trade" %></p>
								</div>
							</article>
						<% end #each %>
					<% end #if, [:completed].size %>
				<% end #each, inventory_needs loop %>

			<% end#if %>

		</div>

		<div class="incomplete-trades">
			<% if @inventory_needs.any? { |x| @need_hash[x.id][:declined].size > 0 } %>
				<h2>Incomplete Trades</h2>
			<% end %>

			<% @inventory_needs.each do |x| %>
				<% if @need_hash[x.id][:declined].size > 0 %>
					
					<% @need_hash[x.id][:declined].each do |y| %>
						
						<article>
							<h3><span>Did not get this book:</span> <%= x.book.name %></h3>
						    
						    <%= image_tag(x.book.thumbnail, alt: x.book.name, class: "bookcover") %>

						    <div class="need-details">	
								<p><strong>Author:</strong> <%= x.book.author %><br />
								<strong>ISBN:</strong> <%= x.book.isbn %><br />
								<strong>Published:</strong> <%= x.book.published %></p>
						    </div>

						    <div class="trade-info">
				    			<p>This trade was canceled before it was completed.</p>
				    			<% #list other users involved in the trade
				    			other_trades = y.get_tradelines_except(session[:user_id])
				    			other_trades.each do |z| 
				    				if z.user_from_accepted %>
				    					<p><%= render :partial => 'users/user', locals: { display_user: z.inventory_own.user } %> has accepted this trade.</p>
				    				<% else %>
				    					<p><%= render :partial => 'users/user', locals: { display_user: z.inventory_own.user } %> was part of this trade.</p>
				    				<% end
				    			end %>

								<p class="action"><%= link_to "View Trade Details", "/trade_details/" + y.id.to_s %></p>
								<p class="action"><%= link_to "Re-propose Trade", "/update_trade/" + y.id.to_s + '?type=repropose', :rel => "facebox", :class => "repropose-trade" %></p>
							</div>
						</article>
					<% end #each %>
				<% end #if, [:declined].size %>
 			<% end #each, inventory_needs loop %>
 		</div>

	</div>
</div>
